id: PF-BUG-002
title: Fix Supabase environment variable name mismatch
type: bug
priority: P0
status: completed
created: 2025-10-06
assignee: ai-agent
completed: 2025-10-06

description: |
  Multiple Supabase helper files were looking for NEXT_PUBLIC_SUPABASE_URL but the
  environment file has SUPABASE_URL (without NEXT_PUBLIC prefix). This caused 500
  errors on routes that fetch data from Supabase.

error_message: |
  Error: Missing Supabase environment variables
  at createServerSupabase (lib/supabase/server.ts:9:11)

reproduction_steps:
  - Navigate to /directory or any route that queries Supabase
  - Server throws: "Missing Supabase environment variables"
  - Page returns 500 error

root_cause: |
  Inconsistent environment variable naming across the codebase:
  
  .env.local has:
  - SUPABASE_URL
  - SUPABASE_ANON_KEY
  - SUPABASE_SERVICE_ROLE_KEY
  
  But code was looking for:
  - NEXT_PUBLIC_SUPABASE_URL (wrong - should be SUPABASE_URL for server-only)
  
  Server-only environment variables should NOT have the NEXT_PUBLIC_ prefix.
  That prefix is for client-side variables only.

proposed_fix: |
  Update all server-side Supabase helpers to use SUPABASE_URL instead of
  NEXT_PUBLIC_SUPABASE_URL:
  
  - lib/supabase/server.ts
  - lib/serverSupabase.ts (already fixed)

acceptance_criteria:
  - ✅ /directory route loads without errors
  - ✅ All Supabase queries work
  - ✅ No "Missing Supabase environment variables" errors
  - ✅ Server can connect to Supabase successfully

files_affected:
  - apps/web/lib/supabase/server.ts (line 5)
  - apps/web/lib/serverSupabase.ts (already fixed earlier)

implementation:
  - Changed NEXT_PUBLIC_SUPABASE_URL to SUPABASE_URL
  - This matches what's actually in .env.local
  - Server-only vars don't need/shouldn't have NEXT_PUBLIC_ prefix

related_tickets:
  - PF-CONFIG-001 (future: standardize env var naming)

notes: |
  Next.js convention:
  - NEXT_PUBLIC_* = exposed to browser (client-side)
  - No prefix = server-only (never sent to browser)
  
  Supabase URLs are public anyway, but service role keys must stay server-only.

